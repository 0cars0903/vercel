<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Business Card Processor v2.3</title>
    <style>
        :root {
            --primary-color: #1877f2;
            --primary-hover: #166fe5;
            --secondary-bg: #e4e6eb;
            --secondary-hover: #d8dbdf;
            --background-color: #f0f2f5;
            --panel-bg: #ffffff;
            --text-primary: #1c1e21;
            --text-secondary: #666;
            --border-color: #ccd0d5;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        *, *::before, *::after { box-sizing: border-box; }
        body, h1, h2, p, ul, li { margin: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        header { text-align: center; margin-bottom: 2rem; }
        .main-layout {
            display: grid;
            /* 화면이 넓을 때 세 개의 패널이 동일한 가로 길이를 갖도록 수정 */
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            align-items: stretch;
        }
        .panel {
            background: var(--panel-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }
        .panel h2 { color: #333; margin-bottom: 1.5rem; border-bottom: 1px solid var(--secondary-bg); padding-bottom: 1rem; }
        .mode-selection { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .btn {
            display: inline-block; padding: 0.75rem 1.5rem; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease;
            text-decoration: none; text-align: center;
        }
        .btn-primary { background-color: var(--primary-color); color: var(--panel-bg); }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-2px); }
        .btn-secondary { background-color: var(--secondary-bg); color: var(--text-primary); }
        .btn-secondary:hover { background-color: var(--secondary-hover); }
        .upload-area {
            border: 2px dashed var(--border-color); border-radius: 8px; padding: 2rem; text-align: center;
            background-color: #f7f8fa; cursor: pointer; transition: background-color 0.2s;
            min-height: 120px; display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .upload-area:hover, .upload-area.dragover { background-color: var(--secondary-bg); }
        .upload-area p { margin: 0; font-size: 1rem; color: var(--text-secondary); }
        .hidden { display: none !important; }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        .input-group input {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border-color);
            border-radius: 6px; font-size: 1rem;
        }
        .result-list { list-style: none; padding: 0; max-height: 65vh; overflow-y: auto; }
        .result-item {
            display: flex; align-items: center; padding: 1rem; border-radius: 8px;
            margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s;
        }
        .result-item.active, .result-item:hover { background-color: #e7f3ff; }
        .result-item img { width: 80px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 1rem; }
        .result-item-info { flex-grow: 1; }
        .result-item-info p { margin: 0; }
        .qr-code img { max-width: 150px; margin: 1rem auto; display: block; }
        
        #editor-panel > div, #results-panel > div { flex-grow: 1; display: flex; flex-direction: column; }
        #editor-empty-state, #results-empty-state { flex-grow: 1; display: flex; align-items: center; justify-content: center; text-align: center; }

        .loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 999;
        }
        .loader-content {
            background: white; padding: 2rem 3rem; border-radius: 12px;
            box-shadow: var(--shadow); text-align: center;
        }
        .loader-steps { list-style: none; padding: 0; margin: 1.5rem 0; text-align: left; }
        .loader-steps li { display: flex; align-items: center; margin-bottom: 1rem; opacity: 0.5; transition: opacity 0.3s ease; font-size: 1.1rem; }
        .loader-steps li.in-progress, .loader-steps li.completed { opacity: 1; }
        .status-icon {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border-color);
            margin-right: 1rem; position: relative; transition: all 0.3s ease;
        }
        .in-progress .status-icon {
            border-color: transparent; border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        .completed .status-icon { background-color: var(--primary-color); border-color: var(--primary-color); }
        .completed .status-icon::after {
            content: ''; position: absolute; left: 8px; top: 4px; width: 5px; height: 10px;
            border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg);
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .action-buttons { margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: center; }
        
        /* 화면 너비에 따른 반응형 레이아웃 수정 */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr 1fr; /* 중간 크기 화면: 2열 */
            }
            #results-panel {
                grid-column: span 2; /* 결과 패널을 넓게 사용 */
            }
        }
        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr; /* 작은 화면: 1열 */
            }
            #results-panel {
                grid-column: auto; /* span 속성 초기화 */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI 명함 처리 시스템 v2.3</h1>
            <p>UI 레이아웃이 개선되었습니다.</p>
        </header>

        <div class="main-layout">
            <!-- Left Panel: Upload -->
            <div class="panel" id="upload-panel">
                <h2>1. 명함 업로드</h2>
                <div class="mode-selection">
                    <button class="btn btn-primary" id="batch-mode-btn" onclick="switchMode('batch')">다중 처리</button>
                    <button class="btn btn-secondary" id="two-sided-mode-btn" onclick="switchMode('two-sided')">양면 처리</button>
                </div>
                
                <div id="batch-mode-ui">
                    <div class="upload-area" id="batch-upload-area"><p>파일을 드래그하거나 클릭</p></div>
                    <input type="file" id="batch-file-input" multiple accept="image/*" class="hidden">
                    <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="processBatchFiles()">일괄 처리 시작</button>
                </div>

                <div id="two-sided-mode-ui" class="hidden">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="upload-area" id="front-upload-area"><p>앞면 (한글)</p></div>
                        <div class="upload-area" id="back-upload-area"><p>뒷면 (영문)</p></div>
                    </div>
                    <input type="file" id="front-file-input" accept="image/*" class="hidden">
                    <input type="file" id="back-file-input" accept="image/*" class="hidden">
                    <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="processTwoSidedFiles()">양면 처리 시작</button>
                </div>
            </div>

            <!-- Center Panel: Edit -->
            <div class="panel" id="editor-panel">
                <h2>2. 정보 수정</h2>
                <div id="editor-ui" class="hidden">
                    <div id="editor-form" style="max-height: 60vh; overflow-y: auto; padding-right: 1rem;"></div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="updateItemData()">수정 내용 저장</button>
                </div>
                <div id="editor-empty-state">
                    <p>좌측에서 명함을 처리하거나<br>우측 목록에서 항목을 선택하면<br>여기에 수정 폼이 표시됩니다.</p>
                </div>
            </div>

            <!-- Right Panel: Results -->
            <div class="panel" id="results-panel">
                <h2>3. 결과 확인</h2>
                <div id="batch-results-ui" class="hidden">
                    <input type="text" class="input-group" id="filter-input" placeholder="이름, 회사 등으로 필터링..." onkeyup="filterResults()">
                    <ul class="result-list" id="result-list"></ul>
                    <hr style="margin: 1rem 0;">
                    <div id="batch-item-details" class="hidden">
                         <div class="qr-code" id="batch-qr-code"></div>
                         <div class="action-buttons">
                            <a href="#" id="batch-vcf-download" class="btn btn-primary">VCF 다운로드</a>
                            <a href="#" id="batch-qr-download" class="btn btn-secondary">QR 코드 저장</a>
                        </div>
                    </div>
                    <div id="download-section" style="margin-top: 1.5rem;">
                         <button class="btn btn-primary" style="width: 100%;" onclick="downloadBatch()">전체 VCF 다운로드</button>
                         <p id="download-notice" style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem; text-align:center;"></p>
                    </div>
                </div>
                <div id="single-result-ui" class="hidden">
                    <div class="qr-code" id="qr-code-display"></div>
                    <div class="action-buttons">
                        <a href="#" id="vcf-download-link" class="btn btn-primary">VCF 다운로드</a>
                        <a href="#" id="qr-download-link" class="btn btn-secondary">QR 코드 저장</a>
                    </div>
                </div>
                <div id="results-empty-state">
                    <p>좌측에서 명함을 업로드하면<br>여기에 결과가 표시됩니다.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="loader hidden" id="loader">
        <div class="loader-content">
            <h3>처리 중입니다...</h3>
            <ul class="loader-steps">
                <li id="step-1"><div class="status-icon"></div><span>OCR 처리</span></li>
                <li id="step-2"><div class="status-icon"></div><span>정보 추출</span></li>
                <li id="step-3"><div class="status-icon"></div><span>VCF/QR 생성</span></li>
            </ul>
            <p id="loader-message">잠시만 기다려주세요.</p>
        </div>
    </div>
    
    <script>
    // --- Configuration ---
    const API_BASE_URL = 'http://localhost:8000';

    // --- State Management ---
    let currentMode = 'batch';
    let batchData = [];
    let activeItemId = null;
    let singleResultData = null;

    document.addEventListener('DOMContentLoaded', () => {
        initializeEventListeners();
        switchMode('batch');
    });

    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('batch-mode-btn').className = mode === 'batch' ? 'btn btn-primary' : 'btn btn-secondary';
        document.getElementById('two-sided-mode-btn').className = mode === 'two-sided' ? 'btn btn-primary' : 'btn btn-secondary';
        document.getElementById('batch-mode-ui').classList.toggle('hidden', mode !== 'batch');
        document.getElementById('two-sided-mode-ui').classList.toggle('hidden', mode !== 'two-sided');
        updatePanelsVisibility();
    }

    function updatePanelsVisibility() {
        const hasBatchData = batchData.length > 0;
        const hasSingleData = singleResultData !== null;
        const isItemSelected = activeItemId !== null;

        document.getElementById('batch-results-ui').classList.toggle('hidden', currentMode !== 'batch' || !hasBatchData);
        document.getElementById('single-result-ui').classList.toggle('hidden', currentMode !== 'two-sided' || !hasSingleData);
        document.getElementById('results-empty-state').classList.toggle('hidden', (currentMode === 'batch' && hasBatchData) || (currentMode === 'two-sided' && hasSingleData));
        
        const showEditor = (currentMode === 'batch' && isItemSelected) || (currentMode === 'two-sided' && hasSingleData);
        document.getElementById('editor-ui').classList.toggle('hidden', !showEditor);
        document.getElementById('editor-empty-state').classList.toggle('hidden', showEditor);
    }
    
    function resetBatchState() {
        batchData = []; activeItemId = null;
        document.getElementById('result-list').innerHTML = '';
        document.getElementById('filter-input').value = '';
        document.getElementById('batch-item-details').classList.add('hidden');
        updatePanelsVisibility();
    }
    function resetSingleState() { singleResultData = null; updatePanelsVisibility(); }

    function initializeEventListeners() {
        const uploadConfigs = [
            { areaId: 'batch-upload-area', inputId: 'batch-file-input' },
            { areaId: 'front-upload-area', inputId: 'front-file-input' },
            { areaId: 'back-upload-area', inputId: 'back-file-input' }
        ];
        uploadConfigs.forEach(({ areaId, inputId }) => {
            const area = document.getElementById(areaId), input = document.getElementById(inputId);
            if (!area || !input) return;
            area.addEventListener('click', () => input.click());
            area.addEventListener('dragover', e => { e.preventDefault(); area.classList.add('dragover'); });
            area.addEventListener('dragleave', () => area.classList.remove('dragover'));
            area.addEventListener('drop', e => {
                e.preventDefault(); area.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    input.files = e.dataTransfer.files;
                    updateUploadAreaText(area, input.files);
                }
            });
            input.addEventListener('change', e => updateUploadAreaText(area, e.target.files));
        });
    }

    function updateUploadAreaText(area, files) {
        const p = area.querySelector('p');
        p.textContent = files.length > 0 ? `${files.length}개 파일 선택됨` : area.id.includes('batch') ? '파일을 드래그하거나 클릭' : area.id.includes('front') ? '앞면 (한글)' : '뒷면 (영문)';
        area.style.backgroundColor = files.length > 0 ? '#e7f3ff' : '#f7f8fa';
    }

    function updateLoaderStep(stepIndex, status) {
        const steps = document.querySelectorAll('.loader-steps li');
        if (steps[stepIndex]) steps[stepIndex].className = status || '';
    }

    function showLoader(isProcessing = true) {
        document.getElementById('loader').classList.remove('hidden');
        document.querySelector('.loader-steps').style.display = isProcessing ? 'block' : 'none';
        document.querySelector('.loader-content h3').textContent = isProcessing ? '처리 중입니다...' : '생성 중입니다...';
        for (let i = 0; i < 3; i++) updateLoaderStep(i, null);
    }
    const hideLoader = () => document.getElementById('loader').classList.add('hidden');

    function renderBatchResults() {
        const listEl = document.getElementById('result-list');
        listEl.innerHTML = '';
        const keyword = document.getElementById('filter-input').value.toLowerCase();
        
        batchData.filter(item => JSON.stringify(item.data).toLowerCase().includes(keyword))
            .forEach(item => {
                const li = document.createElement('li');
                li.className = `result-item ${item.id === activeItemId ? 'active' : ''}`;
                li.id = `item-${item.id}`;
                li.onclick = () => selectItem(item.id);
                li.innerHTML = `<img src="data:image/jpeg;base64,${item.thumbnail}" alt="thumbnail"><div class="result-item-info"><p style="font-weight: 600;">${item.data.name||'이름 없음'}</p><p style="font-size: 0.9rem; color: var(--text-secondary);">${item.data.company||'회사 정보 없음'}</p></div>`;
                listEl.appendChild(li);
            });
        
        document.getElementById('download-notice').textContent = batchData.length >= 2 ? `총 ${batchData.length}개의 VCF가 zip 파일로 다운로드됩니다.` : 'VCF 파일이 다운로드됩니다.';
        updatePanelsVisibility();
    }
    
    function filterResults() { renderBatchResults(); }

    function selectItem(itemId) {
        activeItemId = itemId;
        const item = batchData.find(d => d.id === itemId);
        if (!item) return;

        renderBatchResults();
        renderEditor(item.data, false);
        generateQrAndVcf(item.data, 'batch', false);
        document.getElementById('batch-item-details').classList.remove('hidden');
        updatePanelsVisibility();
    }
    
    function renderEditor(data, isTwoSided) {
        const formEl = document.getElementById('editor-form');
        formEl.innerHTML = '';
        const fields = isTwoSided
            ? { name_ko: '이름(한글)', name_en: '이름(영문)', title_ko: '직책(한글)', title_en: '직책(영문)', company_ko: '회사(한글)', company_en: '회사(영문)', phone: '전화번호', email: '이메일', address_ko: '주소(한글)', address_en: '주소(영문)' }
            : { name: '이름', title: '직책', company: '회사', phone: '전화번호', email: '이메일', address: '주소' };

        for (const [key, label] of Object.entries(fields)) {
            formEl.innerHTML += `<div class="input-group"><label for="edit-${key}">${label}</label><input type="text" id="edit-${key}" value="${data[key] || ''}"></div>`;
        }
    }
    
    async function processFiles(apiEndpoint, formData) {
        showLoader(true);
        try {
            updateLoaderStep(0, 'in-progress');
            await new Promise(r => setTimeout(r, 500)); 
            updateLoaderStep(0, 'completed');
            updateLoaderStep(1, 'in-progress');
            
            const response = await fetch(apiEndpoint, { method: 'POST', body: formData });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Server error');
            }
            const result = await response.json();

            if (!result.success) throw new Error(result.error);
            
            updateLoaderStep(1, 'completed');
            updateLoaderStep(2, 'in-progress');
            return result;
        } finally {
            // Loader hidden by the calling function
        }
    }

    async function processBatchFiles() {
        const { files } = document.getElementById('batch-file-input');
        if (files.length === 0) return alert('파일을 선택해주세요.');
        
        resetBatchState();
        const formData = new FormData();
        for(const file of files) formData.append('images', file);
        
        try {
            const result = await processFiles(`${API_BASE_URL}/api/process-batch`, formData);
            batchData = result.results;
            updateLoaderStep(2, 'completed');
            renderBatchResults();
        } catch (error) {
            alert('오류: ' + error.message);
        } finally {
            await new Promise(r => setTimeout(r, 500));
            hideLoader();
        }
    }

    async function processTwoSidedFiles() {
        const frontFile = document.getElementById('front-file-input').files[0];
        const backFile = document.getElementById('back-file-input').files[0];
        if (!frontFile || !backFile) return alert('앞면과 뒷면 파일을 모두 선택해주세요.');
        
        resetSingleState();
        const formData = new FormData();
        formData.append('frontImage', frontFile);
        formData.append('backImage', backFile);
        
        try {
            const result = await processFiles(`${API_BASE_URL}/api/process-two-sided`, formData);
            await generateQrAndVcf(result.contactInfo, 'single', false);
            updateLoaderStep(2, 'completed');
            
            singleResultData = result.contactInfo;
            renderEditor(singleResultData, true);
            updatePanelsVisibility();
        } catch (error) {
            alert('처리 중 오류가 발생했습니다: ' + error.message);
        } finally {
            await new Promise(r => setTimeout(r, 500));
            hideLoader();
        }
    }
    
    async function downloadBatch() {
        if (batchData.length === 0) return alert('다운로드할 데이터가 없습니다.');
        showLoader(false);
        try {
            const response = await fetch(`${API_BASE_URL}/api/download-batch`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ items: batchData })
            });
            if (response.ok) {
                const blob = await response.blob(), url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.style.display = 'none'; a.href = url;
                const disposition = response.headers.get('Content-Disposition');
                let filename = 'contacts.zip';
                if (disposition) {
                    const match = disposition.match(/filename="(.+)"/);
                    if (match) filename = match[1];
                }
                a.download = filename; document.body.appendChild(a); a.click();
                window.URL.revokeObjectURL(url); document.body.removeChild(a);
            } else alert('다운로드 실패');
        } catch (error) { alert('다운로드 중 오류가 발생했습니다: ' + error.message); } 
        finally { hideLoader(); }
    }

    function updateItemData() {
        let dataObject;
        if (currentMode === 'batch') {
            if (!activeItemId) return alert('수정할 항목을 선택해주세요.');
            const item = batchData.find(d => d.id === activeItemId);
            if (!item) return; dataObject = item.data;
        } else {
            if (!singleResultData) return alert('수정할 데이터가 없습니다.');
            dataObject = singleResultData;
        }
        const form = document.getElementById('editor-form');
        form.querySelectorAll('input').forEach(input => {
            const key = input.id.replace('edit-', '');
            if (key in dataObject) dataObject[key] = input.value;
        });
        alert('저장되었습니다.');
        if (currentMode === 'batch') {
            renderBatchResults(); selectItem(activeItemId);
        } else {
            renderEditor(dataObject, true); generateQrAndVcf(dataObject, 'single');
        }
    }

    async function generateQrAndVcf(data, type, showOwnLoader = true) {
        if (showOwnLoader) showLoader(false);
        try {
            const response = await fetch(`${API_BASE_URL}/api/generate-vcf-qr`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contactData: data })
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            const name = data.name_en || data.name_ko || data.name || 'contact';
            const qrImgSrc = `data:image/png;base64,${result.qrCode}`;
            
            const ids = type === 'batch' 
                ? { qr: 'batch-qr-code', vcf: 'batch-vcf-download', qrLink: 'batch-qr-download' }
                : { qr: 'qr-code-display', vcf: 'vcf-download-link', qrLink: 'qr-download-link' };

            document.getElementById(ids.qr).innerHTML = `<img src="${qrImgSrc}" alt="QR Code">`;
            const vcfLink = document.getElementById(ids.vcf);
            vcfLink.href = URL.createObjectURL(new Blob([result.vcfContent], { type: 'text/vcard' }));
            vcfLink.download = `${name}.vcf`;
            
            const qrLink = document.getElementById(ids.qrLink);
            qrLink.href = qrImgSrc;
            qrLink.download = `${name}_qrcode.png`;
        } catch(error) {
            console.error("QR/VCF Generation Error:", error);
            alert("QR/VCF 생성 중 오류가 발생했습니다.");
        } finally {
            if (showOwnLoader) hideLoader();
        }
    }
    </script>
</body>
</html>



